'
'  Copyright (c) 2021 Daimler TSS GmbH
'
'  This program and the accompanying materials are made available under the
'  terms of the Apache License, Version 2.0 which is available at
'  https://www.apache.org/licenses/LICENSE-2.0
'
'  SPDX-License-Identifier: Apache-2.0
'
'  Contributors:
'       Daimler TSS GmbH - Initial Draft
'
'

@startuml

skinParam NoteBackgroundColor WhiteSmoke
skinParam NoteFontColor Black
skinParam ParticipantBackgroundColor WhiteSmoke
skinParam ActorBackgroundColor WhiteSmoke
skinParam AgentBackgroundColor White
skinParam AgentBorderColor SkyBlue
skinparam shadowing false

!define ConsumerColor f8f2ff
!define ProviderColor d9edff
!define WarningColor Business
!define LeadColor Technology

skinparam noteBackgroundColor #LeadColor

autonumber

box EDC Consumer #ConsumerColor

    actor Actor as "Artifact Requesting\nController/Handler"
    participant Store as "Contract Negotiation Store"
    participant TransferStore as "Transfer Process Store"
    participant TransferManager as "Transfer Process Manager"
    participant ManifestGenerator as "Resource Manifest Generator"
    participant ProvisionManager as "Provision Manager"
    participant Provisioners as "Provisioners" #lightblue
    participant Dispatcher as "Remote Message Dispatcher" #lightblue
    participant IDS as "IDS Services\n(Controller, Dispatcher, ...)" #lightblue
end box

participant Provider as "Provider" #ProviderColor

' PROCESS
Actor -> TransferManager ++: initialize TransferProcess by ContractRef and Artifact


TransferManager -> Store ++: get contract
return contract
TransferManager -> TransferStore: store TransferProcess

' Resource Definition
TransferManager -> ManifestGenerator ++ : generate resource definitions
return ResourceManifest
TransferManager -> TransferStore: store TransferProcess


' Provision
hnote right of TransferManager
    Resource Provision
end note

TransferManager -> ProvisionManager++: provision
ProvisionManager -> Provisioners++: provision
Provisioners --> ProvisionManager--: callback
ProvisionManager -> TransferStore: store TransferProcess
deactivate ProvisionManager

' Artifact Message
hnote right of TransferManager
    Send Artifact Request
end note

TransferManager -> Dispatcher ++ : invoke remote message
Dispatcher -> IDS ++ : dispatch
IDS -> Provider ++ : Artifact Request Message
return Request in Process Message
return
Dispatcher -> TransferStore --: store TransferProcess

' Transfer
hnote right of TransferManager
    Data Transfer done by provider (push)
end note

' De-Provision
TransferManager -> ProvisionManager++: deprovision
ProvisionManager -> Provisioners++: deprovision
Provisioners --> ProvisionManager--: callback
ProvisionManager -> TransferStore: store TransferProcess
deactivate ProvisionManager

' Look again at step 21 for non-edc connectors

@enduml